<html>
<head>
	<meta charset="utf-8"> 
    <title>Canhão</title>
    <style>
	form {
	width:330px;
	margin:20px;
	background-color:brown;
	padding:20px;
	color:yellow;
	}
	#pontuacao{
		vertical-align: top;
		
	}
	</style>
    <script type="text/javascript">
    //define bola, imagem, retangulos para objeto em canvas. Cada um tem um método de desenho.
	//Cada objeto desenhado no canbas corresponde a um elemento no array everything.
	//cada elemento é um array, com alguns dos valore usados para fazer uma rotação.
	var cwidth = 600;
	var cheight = 400;
	var ctx;
	var everything = [];
	var tid;
	var outofcannon;
	var horvelocity;
	var verticalvel1;
	var verticalvel2;
	var gravity = 2;  //define a gravidade da bola
	var cannonx = 10;
	var cannony = 280;
	var cannonlength = 200;
	var cannonht = 20;
	var ballrad = 10;
	var targetx = 500;
	var targety = 50;
	var targetw = 85;
	var targeth = 280;
	var htargetx = 450;
	var htargety = 220;
	var htargetw = 355;
	var htargeth = 96;
	var groundx = 0;
	var groundy = 300;
	var groundw = 600;
	var groundh = 600;

	
	if(typeof pontos == undefined || isNaN(pontos)){
		var pontos = 0;
	} else{
		pontos +=pontos;
	}

	



	
function Ball(sx,sy,rad,stylestring) {
  this.sx = sx;
  this.sy = sy;
  this.rad = rad;
  this.draw = drawball;
  this.moveit = moveball;
  this.fillstyle = stylestring;
}

function drawball() {
	ctx.fillStyle=this.fillstyle;
	ctx.beginPath();
	ctx.arc(this.sx,this.sy,this.rad,0,Math.PI*2,true);
	ctx.fill();	
}

//função que mostra a pontuação
function pontuacao(){
	var total = document.getElementById(pontuacao);
	if (typeof total != 'undefined') {
		total += 10;
	} else {
		total=10;
	}
	var qtdPontos = document.getElementById("pontuacao");
	qtdPontos.innerHTML = total;
}

function moveball(dx,dy) {
	this.sx +=dx;
	this.sy +=dy;
}

var cball = new Ball(cannonx+cannonlength,cannony+cannonht*.5,ballrad,"rgb(250,0,0)");


//função que dispara o som do tiro de canhão
function playAudioCanhao() {
    var som = new Audio("canhao.wav");
    som.play();
}


function Myrectangle(sx,sy,swidth,sheight,stylestring) {
	this.sx = sx;
	this.sy = sy;
	this.swidth = swidth;
	this.sheight = sheight;
	this.fillstyle = stylestring;
	this.draw = drawrects;
	this.moveit = moveball;
}

function drawrects() {
	ctx.fillStyle = this.fillstyle;
	ctx.fillRect(this.sx,this.sy,this.swidth,this.sheight);	
}



function Picture (sx,sy,swidth,sheight,filen) {
	var imga = new Image();
	imga.src=filen;
	this.sx = sx;
	this.sy = sy;
	this.img = imga;
	this.swidth = swidth;
	this.sheight = sheight;
	this.draw = drawAnImage;
	this.moveit = moveball;
}
function drawAnImage() {
	ctx.drawImage(this.img,this.sx,this.sy,this.swidth,this.sheight);
	
}
var target = new Picture(targetx,targety,targetw,targeth,"hill.jpg");
var htarget = new Picture(htargetx, htargety, htargetw, htargeth, "plateau.jpg");
var ground = new Myrectangle(groundx,groundy,groundw,groundh,"rgb(10,250,0)");
var cannon = new Myrectangle(cannonx,cannony,cannonlength,cannonht,"rgb(40,40,0)");
var targetindex = everything.length;
everything.push([target,false]);
everything.push([ground,false]);
var ballindex = everything.length;
everything.push([cball,false]);
var cannonindex = everything.length;  //save to use later
everything.push([cannon,true,0,cannonx,cannony+cannonht*.5]);  // will set rotation later

function init(){
   ctx = document.getElementById('canvas').getContext('2d'); 
  
  drawall();  
} 
function fire() {
	
  playAudioCanhao();

	drawall();
	tid = setInterval(change,100);

	return false;
}

function drawall() {
	ctx.clearRect(0,0,cwidth,cheight);
	var i;
	for (i=0;i<everything.length;i++) {
		var ob = everything[i];
		if (ob[1]) {  //need to translate and rotate
			ctx.save();
			ctx.translate(ob[3],ob[4]);
			ctx.rotate(ob[2]);
			ctx.translate(-ob[3],-ob[4]);
			ob[0].draw();
			ctx.restore(); }
		else {
		  ob[0].draw();
		}
	}
}

function keypress(keyEvent) {
	//UP: 38
	//DOWN: 40
	//RIGHT: 39
	//LEFT: 37
	var k = keyEvent.keyCode;
	var a = Number(document.f.ang.value);
	var v = Number(document.f.vo.value);
	if(k === 38) {
		a++;
	} else if(k === 40) {
		a--;
	} else if(k === 39) {
		v++;
	} else if(k === 37) {
		v--;
	} else if(k === 13) {
		document.getElementById('fireButton').click();
	}
	document.f.ang.value = a;
	document.f.vo.value = v;
	drawall();
  	var angle = Number(document.f.ang.value);
  	var outofcannon = Number(document.f.vo.value);
  	var angleradians = angle*Math.PI/180;
  	horvelocity =  outofcannon*Math.cos(angleradians);
  	verticalvel1 = - outofcannon*Math.sin(angleradians);
  	everything[cannonindex][2]= - angleradians;
  	cball.sx = cannonx + cannonlength*Math.cos(angleradians);
  	cball.sy = cannony+cannonht*.5 - cannonlength*Math.sin(angleradians);
}

function change() {
	var dx = horvelocity;
	verticalvel2 = verticalvel1 + gravity;
	var dy = (verticalvel1 + verticalvel2)*.5;
	verticalvel1 = verticalvel2;
	cball.moveit(dx,dy);
	//verifica se atingiu o alvo
	var bx = cball.sx;
	var by = cball.sy;
	if ((bx>=target.sx)&&(bx<=(target.sx+target.swidth))&&
	(by>=target.sy)&&(by<=(target.sy+target.sheight))) {
		clearInterval(tid);
		//remove target e insere htarget
		everything.splice(targetindex,1,[htarget,false]);
		everything.splice(ballindex,1);
		drawall();
		pontuacao();
		cball = new Ball(cannonx+cannonlength,cannony+cannonht*.5,ballrad,"rgb(250,0,0)");
	}
	//verifica se alcançou o chão
	if (by>=ground.sy) {
		clearInterval(tid);
	}
	drawall();	
}

</script>
</head>
<body onLoad="init();" onkeyup='keypress(event)'>  
<h1> Você tem <span id="pontuacao"> 0 </span>  pontos </h1>
<div style="clear:both;"></div>
<canvas id="canvas" width="600" height="400">

Seu browser não suporta o elemento canvas do HTML5.
</canvas>

<br/>
<form name="f" id="f" onSubmit="return fire();">
Defina a velocidade, ângulo e clique em atirar. <br/>
Ou utilize as teclas [CIMA/BAIXO para angulo, DIREITA/ESQUERDA para velocidade e ENTER para atirar] 
Velocidade do canhão <input name="vo" id="vo" value="10" type="number" min="-100" max="100" /> 
<br>
Ângulo <input name="ang" id="ang" value="0" type="number" min="0" max="80"/>
<input id="fireButton" type="submit" value="FOGO"/>
</form> 
</body>
</html>